<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">

<meta name='viewport' content='width=device-width,maximum-scale=1.0,initial-scale=1.0,user-scalable=no'/>
<meta name='format-detection' content='telephone=no'/>
<meta name='format-detection' content='address=no'>
<title></title>



<style>
* {
	margin: 0;
	padding: 0;
	box-sizing: border-box;
}
</style>

<script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>
<script>
// Отправляет событие инициализации нативному клиенту
vkBridge.send('VKWebAppInit');
</script>

</head>
<body>
<center>



<div id='main' style='padding: 0px 0px 0px 0px; background:#000; width:360px; overflow:;'>
<div id='content' style='position:relative; padding: 0px 0px 0px 0px;'>


<iframe src="iframe.html" width="360" "></iframe>

<div id='main_pic' class='' style='margin: 0px 0px 0px 0px; background: url(Flux_Dev_a_cinematic_anime_keyframe_with_a_mix_of_styles_from__1.jpg), #000; background-size:100% 100%; padding: 0px; box-sizing:border-box; position:relative; height: 720px; height: 70px; width: 100%; z-index:2; '></div>

	
<!-- Put this script tag to the <head> of your page -->
<script type="text/javascript" src="https://vk.com/js/api/openapi.js?168"></script>
<script type="text/javascript">
  VK.init({ apiId: 54230573, onlyWidgets: true });
</script>

<!-- Put this div tag to the place, where the Comments block will be -->
<div id="vk_comments"></div>
<script type="text/javascript">
VK.Widgets.Comments("vk_comments", {limit: 5, attach: "false",}, 12345);
</script>

<script>
VK.Observer.subscribe("widgets.comments.delete_comment", function f() {
    console.log('Комментарий удален!');
});
	
VK.Observer.subscribe("widgets.comments.new_comment", function(num, last_comment, date, sign) {
    console.log('Добавлен новый комментарий!');
    console.log('Количество комментариев:', num);
    console.log('Текст комментария:', last_comment);
    console.log('Дата:', date);
    console.log('Подпись:', sign);
});







class VKIframeMonitor {
  constructor() {
    this.iframes = new Map();
    this.errorCounts = new Map();
    this.init();
  }
  
  init() {
    // 1. Отслеживаем существующие iframe
    this.scanExistingIframes();
    
    // 2. Наблюдаем за новыми iframe
    this.setupMutationObserver();
    
    // 3. Настраиваем перехват ошибок
    this.setupErrorHandling();
    
    console.log('VK Iframe Monitor запущен');
  }
  
  scanExistingIframes() {
    const iframes = document.querySelectorAll('iframe[src*="widget_comments.php"]');
    iframes.forEach((iframe, index) => {
      this.registerIframe(iframe);
    });
  }
  
  registerIframe(iframe) {
    try {
      const url = new URL(iframe.src);
      const page = url.searchParams.get('page');
      
      if (!page) return;
      
      // Создаем уникальный ID
      const iframeId = `vk_${page}_${Date.now()}`;
      
      // Добавляем атрибуты для идентификации
      iframe.dataset.vkMonitorId = iframeId;
      iframe.dataset.vkPage = page;
      iframe.dataset.vkApp = url.searchParams.get('app') || 'unknown';
      
      // Добавляем стиль для визуальной идентификации
      iframe.style.border = '2px solid #4CAF50';
      iframe.style.boxSizing = 'border-box';
      
      // Создаем контейнер для информации
      const infoDiv = document.createElement('div');
      infoDiv.className = 'vk-iframe-info';
      infoDiv.innerHTML = `
        <div style="background:#f0f0f0; padding:5px; font-size:12px; border:1px solid #ccc">
          VK Iframe: page=${page}, ID=${iframeId}
          <button onclick="document.querySelector('[data-vk-monitor-id=\"${iframeId}\"]').style.border='2px solid red'">
            Показать
          </button>
        </div>
      `;
      
      iframe.parentNode.insertBefore(infoDiv, iframe);
      
      // Сохраняем в карту
      this.iframes.set(iframeId, {
        element: iframe,
        page: page,
        url: iframe.src,
        errors: [],
        errorCount: 0
      });
      
      console.log(`Зарегистрирован iframe: ID=${iframeId}, page=${page}`);
      
    } catch (e) {
      console.warn('Ошибка регистрации iframe:', e);
    }
  }
  
  setupMutationObserver() {
    const observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        mutation.addedNodes.forEach((node) => {
          if (node.tagName === 'IFRAME') {
            setTimeout(() => {
              if (node.src && node.src.includes('widget_comments.php')) {
                this.registerIframe(node);
              }
            }, 100);
          }
        });
      });
    });
    
    observer.observe(document.body, { childList: true, subtree: true });
  }
  
  setupErrorHandling() {
    // Глобальный перехват ошибок
    const originalError = console.error;
    console.error = (...args) => {
      originalError.apply(console, args);
      
      // Пытаемся определить источник ошибки
      const errorStack = new Error().stack;
      if (errorStack && args.some(arg => 
        typeof arg === 'string' && 
        arg.includes('newCnt is not defined')
      )) {
        this.handleVKError(args, errorStack);
      }
    };
  }
  
  handleVKError(errorArgs, stack) {
    // Анализируем стек вызовов для определения iframe
    const stackLines = stack.split('\n');
    
    // Ищем в стеке упоминания widget_comments.php
    for (const line of stackLines) {
      for (const [iframeId, data] of this.iframes.entries()) {
        if (line.includes('widget_comments.php') && line.includes(`page=${data.page}`)) {
          data.errorCount++;
          data.errors.push({
            message: errorArgs.join(' '),
            timestamp: new Date().toISOString(),
            stack: stack
          });
          
          console.log(`⚠️ Ошибка VK обнаружена!`);
          console.log(`   Iframe ID: ${iframeId}`);
          console.log(`   Page: ${data.page}`);
          console.log(`   Ошибок всего: ${data.errorCount}`);
          console.log(`   URL: ${data.url}`);
          
          // Визуально выделяем iframe с ошибкой
          data.element.style.border = '3px solid #FF5722';
          data.element.style.boxShadow = '0 0 10px rgba(255, 87, 34, 0.5)';
          
          // Создаем всплывающее уведомление
          this.showNotification(`Ошибка в iframe page=${data.page}`, iframeId);
          
          return;
        }
      }
    }
    
    console.log('Ошибка VK, но iframe не определен:', errorArgs);
  }
  
  showNotification(message, iframeId) {
    const notification = document.createElement('div');
    notification.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: #FF5722;
      color: white;
      padding: 15px;
      border-radius: 5px;
      z-index: 9999;
      max-width: 300px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      cursor: pointer;
    `;
    
    notification.innerHTML = `
      <strong>VK Error Detected</strong><br>
      ${message}<br>
      <small>Click to highlight iframe</small>
    `;
    
    notification.onclick = () => {
      const iframe = this.iframes.get(iframeId)?.element;
      if (iframe) {
        iframe.scrollIntoView({ behavior: 'smooth', block: 'center' });
        iframe.style.border = '4px solid #FF9800';
        setTimeout(() => {
          iframe.style.border = '3px solid #FF5722';
        }, 2000);
      }
      notification.remove();
    };
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
      if (notification.parentNode) {
        notification.remove();
      }
    }, 5000);
  }
  
  // Методы для получения статистики
  getStats() {
    const stats = {};
    for (const [id, data] of this.iframes.entries()) {
      stats[id] = {
        page: data.page,
        errorCount: data.errorCount,
        lastError: data.errors.length > 0 ? data.errors[data.errors.length - 1] : null,
        url: data.url
      };
    }
    return stats;
  }
  
  getIframeByPage(page) {
    for (const [id, data] of this.iframes.entries()) {
      if (data.page === page) {
        return { id, ...data };
      }
    }
    return null;
  }
}

// Инициализация
const vkMonitor = new VKIframeMonitor();

// Для отладки - выводим все iframe каждые 5 секунд
setInterval(() => {
  const stats = vkMonitor.getStats();
  console.log('=== VK Iframe Monitor Stats ===');
  console.table(Object.values(stats));
}, 5000);







	
</script>



</center>
</body>

</html>





















